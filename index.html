<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Foldable RSS Reader ✨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        :root {
            --primary: #4f46e5;
            --bg: #ffffff;
            --surface: #f8fafc;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            overscroll-behavior-y: contain;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pane {
            height: 100%;
            overflow-y: auto;
            transition: width 0.3s ease;
        }

        @media (min-width: 768px) {
            .pane-list { width: 400px; border-right: 1px solid #e2e8f0; }
            .pane-content { flex: 1; }
            .back-btn { display: none; }
        }

        @media (max-width: 767px) {
            .pane-list { width: 100%; }
            .pane-content { 
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                z-index: 40;
                transform: translateX(100%);
                background: white;
            }
            .pane-content.active { transform: translateX(0); }
        }

        .pull-indicator {
            position: fixed;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            transition: transform 0.1s linear;
            z-index: 50;
        }

        .article-card {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .article-card.active {
            background-color: #f1f5f9;
            border-left-color: var(--primary);
        }

        .article-card.is-read {
            opacity: 0.5;
            background-color: #f8fafc;
        }

        .category-pill {
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #f8fafc 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .ai-chat-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 0.875rem;
            margin-bottom: 8px;
        }
        .ai-user { background: #4f46e5; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-bot { background: #f1f5f9; color: #1e293b; align-self: flex-start; border-bottom-left-radius: 4px; }

        .modal-overlay {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }

        #reader-body img {
            border-radius: 12px;
            margin: 1.5rem 0;
            width: 100%;
            height: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        #reader-body iframe {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 12px;
            margin: 1.5rem 0;
        }
        
        /* Hide scrollbars but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app" class="app-container">
        <!-- Pull to Refresh Icon -->
        <div id="pull-indicator" class="pull-indicator bg-indigo-600 text-white p-3 rounded-full shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="refresh-icon"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>
        </div>

        <!-- Sidebar / List Pane -->
        <div class="pane pane-list flex flex-col bg-white">
            <header class="h-16 px-6 border-b flex items-center justify-between sticky top-0 bg-white/80 backdrop-blur z-20">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
                    </div>
                    <h1 class="font-extrabold text-xl tracking-tight text-slate-900">FoldRSS</h1>
                </div>
                <div class="flex items-center gap-1">
                    <button id="toggle-read-filter" onclick="toggleReadVisibility()" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors" title="Toggle Hidden Read Articles">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="eye-icon"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                    <button onclick="clearReadState()" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors" title="Clear Read History">
                         <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                    </button>
                    <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                </div>
            </header>

            <!-- Categories Horizontal Filter -->
            <div id="categories-filter" class="flex gap-2 overflow-x-auto px-6 py-3 border-b bg-slate-50 no-scrollbar"></div>

            <div id="article-list" class="flex-1 overflow-y-auto">
                <div class="p-6 space-y-4" id="shimmer-loader">
                    <div class="h-4 w-2/3 loading-shimmer rounded"></div>
                    <div class="h-8 w-full loading-shimmer rounded"></div>
                    <div class="h-4 w-1/2 loading-shimmer rounded"></div>
                </div>
            </div>
        </div>

        <!-- Content Pane -->
        <div id="content-pane" class="pane pane-content flex flex-col bg-white">
            <div id="empty-state" class="flex-1 flex flex-col items-center justify-center p-12 text-center">
                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-4 text-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5Z"></path><path d="M8 7h6"></path><path d="M8 11h8"></path></svg>
                </div>
                <h3 class="font-bold text-slate-800">No article selected</h3>
                <p class="text-slate-400 text-sm mt-1 max-w-[200px]">Select an item from the stream to start reading with AI.</p>
            </div>

            <div id="reader-view" class="hidden flex flex-col h-full">
                <header class="h-16 px-4 border-b flex items-center justify-between sticky top-0 bg-white/80 backdrop-blur z-10">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <button onclick="closeReader()" class="back-btn p-2 hover:bg-slate-100 rounded-full shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg>
                        </button>
                        <div class="truncate">
                            <span id="reader-source" class="text-[10px] font-black uppercase tracking-widest bg-slate-100 px-2 py-0.5 rounded">Source</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <a id="reader-original-link" target="_blank" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors" title="View Original Website">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 22 3 22 10"></polyline><line x1="14" y1="10" x2="22" y2="2"></line></svg>
                        </a>
                        <button id="ai-summarize-btn" class="flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-tr from-indigo-600 to-purple-600 text-white text-xs font-bold rounded-lg shadow-md hover:shadow-lg transition-all active:scale-95">
                            ✨ SUMMARIZE
                        </button>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto px-6 py-8 md:px-12 relative" id="reader-scroll-container">
                    <div id="ai-sentiment" class="hidden mb-4 inline-flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold border"></div>

                    <div id="ai-summary" class="hidden mb-8 p-6 bg-slate-900 text-slate-50 rounded-2xl shadow-xl border border-slate-700 animate-in slide-in-from-top">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-indigo-400">✨</span>
                                <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400">AI Intelligence Brief</span>
                            </div>
                            <button onclick="document.getElementById('ai-summary').classList.add('hidden')" class="text-slate-500 hover:text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                            </button>
                        </div>
                        <div id="summary-text" class="text-sm leading-relaxed opacity-90 prose prose-invert max-w-none">Generating summary...</div>
                    </div>

                    <article class="max-w-2xl mx-auto">
                        <h2 id="reader-title" class="text-3xl font-extrabold text-slate-900 leading-tight mb-4 text-balance">Article Title</h2>
                        <div id="reader-meta" class="text-xs text-slate-400 mb-8 pb-4 border-b border-slate-100 flex items-center gap-4">
                            <span id="reader-date">Jan 1, 2024</span>
                        </div>
                        <div id="reader-body" class="prose prose-slate prose-indigo max-w-none text-slate-700 leading-relaxed space-y-4"></div>
                    </article>

                    <div class="mt-16 max-w-2xl mx-auto border-t pt-10">
                        <div class="flex items-center gap-2 mb-6">
                            <span class="text-indigo-600">✨</span>
                            <h4 class="font-bold text-slate-800">Ask the Article</h4>
                        </div>
                        <div id="ai-chat-history" class="flex flex-col gap-2 mb-4"></div>
                        <div class="flex gap-2">
                            <input type="text" id="ai-chat-input" placeholder="Ask about this article..." class="flex-1 bg-slate-100 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <button id="ai-chat-send" class="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"></path><path d="M22 2 11 13"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="h-32"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <header class="p-6 border-b flex items-center justify-between">
                <h2 class="text-xl font-black text-slate-900">Manage Feeds</h2>
                <button onclick="toggleSettings()" class="p-2 hover:bg-slate-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                </button>
            </header>
            
            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                <!-- Add Feed -->
                <div>
                    <h3 class="text-xs font-black uppercase text-slate-400 mb-3 tracking-widest">Add New Feed</h3>
                    <div class="space-y-2">
                        <input type="text" id="new-feed-url" placeholder="Paste RSS/Atom link here..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:border-indigo-500 outline-none">
                        <div class="flex gap-2">
                            <select id="new-feed-category" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:border-indigo-500 outline-none">
                                <option value="General">General</option>
                                <option value="Tech">Tech</option>
                                <option value="News">News</option>
                                <option value="Design">Design</option>
                                <option value="Science">Science</option>
                                <option value="Custom">+ Add New Category</option>
                            </select>
                            <input type="text" id="custom-category-input" placeholder="Category name..." class="hidden flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:border-indigo-500 outline-none">
                            <button onclick="addFeedManual()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-indigo-700">ADD</button>
                        </div>
                    </div>
                </div>

                <!-- OPML Import -->
                <div>
                    <h3 class="text-xs font-black uppercase text-slate-400 mb-3 tracking-widest">Import File (.opml, .xml)</h3>
                    <label id="drop-zone" class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition-all">
                        <div id="import-status" class="flex flex-col items-center justify-center">
                            <p class="text-xs text-slate-500"><span class="font-bold">Click to upload OPML</span> or drag and drop</p>
                        </div>
                        <input type="file" id="opml-input" class="hidden" accept=".opml,.xml,.rss" onchange="handleOPMLUpload(event)" />
                    </label>
                </div>

                <!-- Feed List -->
                <div>
                    <h3 class="text-xs font-black uppercase text-slate-400 mb-3 tracking-widest">Active Subscriptions</h3>
                    <div id="settings-feed-list" class="space-y-4"></div>
                </div>
            </div>
            
            <footer class="p-6 border-t bg-slate-50 flex justify-end gap-2">
                <button onclick="resetFeeds()" class="px-4 py-2 text-xs font-bold text-rose-600 hover:bg-rose-50 rounded-lg">RESET TO DEFAULT</button>
                <button onclick="toggleSettings()" class="px-6 py-2 bg-slate-900 text-white text-xs font-bold rounded-lg shadow-lg">CLOSE</button>
            </footer>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const modelName = "gemini-2.5-flash-preview-09-2025";
        
        const DEFAULT_FEEDS = [
            { url: 'https://feeds.feedburner.com/TechCrunch/', category: 'Tech' },
            { url: 'https://www.theverge.com/rss/index.xml', category: 'Tech' },
            { url: 'https://arstechnica.com/feed/', category: 'Tech' },
            { url: 'https://www.wired.com/feed/rss', category: 'News' }
        ];

        // Category Color Mapping
        const CATEGORY_COLORS = {
            'Tech': { bg: 'bg-indigo-500', text: 'text-indigo-600', light: 'bg-indigo-50' },
            'News': { bg: 'bg-emerald-500', text: 'text-emerald-600', light: 'bg-emerald-50' },
            'Design': { bg: 'bg-rose-500', text: 'text-rose-600', light: 'bg-rose-50' },
            'Science': { bg: 'bg-purple-500', text: 'text-purple-600', light: 'bg-purple-50' },
            'General': { bg: 'bg-slate-500', text: 'text-slate-600', light: 'bg-slate-50' },
            'Default': { bg: 'bg-blue-500', text: 'text-blue-600', light: 'bg-blue-50' }
        };

        function getCategoryStyle(category) {
            return CATEGORY_COLORS[category] || CATEGORY_COLORS['Default'];
        }

        let state = {
            feeds: JSON.parse(localStorage.getItem('rss_feeds_v2')) || DEFAULT_FEEDS,
            articles: [],
            readArticles: new Set(JSON.parse(localStorage.getItem('rss_read_v2') || '[]')),
            selectedArticleId: null,
            isRefreshing: false,
            chatHistory: [],
            selectedCategory: 'All',
            showRead: false
        };

        // --- Read State Management ---

        function toggleReadVisibility() {
            state.showRead = !state.showRead;
            const eyeIcon = document.getElementById('eye-icon');
            const btn = document.getElementById('toggle-read-filter');
            
            if (state.showRead) {
                eyeIcon.innerHTML = `<path d="M9.88 9.88l-3.29-3.29m7.53 7.53l3.29 3.29M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68M6.61 6.61A13.52 13.52 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61M12 9a3 3 0 0 1 3 3m-3-3a3 3 0 0 0-3 3"></path><line x1="2" y1="2" x2="22" y2="22"></line>`;
                btn.classList.add('text-indigo-600');
            } else {
                eyeIcon.innerHTML = `<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle>`;
                btn.classList.remove('text-indigo-600');
            }
            renderArticles();
        }

        function markAsRead(id) {
            state.readArticles.add(id);
            localStorage.setItem('rss_read_v2', JSON.stringify([...state.readArticles]));
            renderArticles();
        }

        function clearReadState() {
            if(confirm("Clear read history?")) {
                state.readArticles = new Set();
                localStorage.removeItem('rss_read_v2');
                renderArticles();
            }
        }

        // --- Feed Management ---

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                renderSettingsFeedList();
                updateCategoryOptions();
            }
        }

        document.getElementById('new-feed-category').addEventListener('change', function(e) {
            const customInput = document.getElementById('custom-category-input');
            if (e.target.value === 'Custom') customInput.classList.remove('hidden');
            else customInput.classList.add('hidden');
        });

        function updateCategoryOptions() {
            const select = document.getElementById('new-feed-category');
            const categories = [...new Set(state.feeds.map(f => f.category))];
            const standards = ["General", "Tech", "News", "Design", "Science"];
            const allCats = [...new Set([...standards, ...categories])];
            const currentVal = select.value;
            select.innerHTML = allCats.map(cat => `<option value="${cat}">${cat}</option>`).join('') + '<option value="Custom">+ Add New Category</option>';
            select.value = currentVal;
        }

        function renderCategoriesFilter() {
            const container = document.getElementById('categories-filter');
            const categories = ['All', ...new Set(state.feeds.map(f => f.category))];
            container.innerHTML = categories.map(cat => {
                const style = getCategoryStyle(cat);
                const isActive = state.selectedCategory === cat;
                return `
                <div onclick="selectCategory('${cat}')" 
                     class="category-pill px-4 py-1.5 rounded-full text-xs font-bold border transition-all 
                     ${isActive ? `${style.bg} text-white border-transparent shadow-sm` : `bg-white text-slate-500 border-slate-200 hover:border-slate-300`}">
                    ${cat}
                </div>
            `;}).join('');
        }

        function selectCategory(cat) {
            state.selectedCategory = cat;
            renderCategoriesFilter();
            renderArticles();
        }

        function renderSettingsFeedList() {
            const list = document.getElementById('settings-feed-list');
            const grouped = state.feeds.reduce((acc, feed) => {
                if (!acc[feed.category]) acc[feed.category] = [];
                acc[feed.category].push(feed);
                return acc;
            }, {});

            let html = '';
            for (const [category, feeds] of Object.entries(grouped)) {
                const style = getCategoryStyle(category);
                html += `
                    <div>
                        <h4 class="text-[10px] font-black ${style.text} uppercase tracking-widest mb-2 border-b pb-1">${category}</h4>
                        <div class="space-y-1.5">
                            ${feeds.map(feed => {
                                const index = state.feeds.findIndex(f => f.url === feed.url);
                                return `
                                    <div class="flex items-center justify-between p-2 px-3 bg-slate-50 border border-slate-100 rounded-lg group">
                                        <span class="text-[11px] font-medium text-slate-600 truncate flex-1 pr-4">${feed.url}</span>
                                        <button onclick="removeFeed(${index})" class="text-slate-400 hover:text-rose-600 transition-all">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            list.innerHTML = html || '<p class="text-center py-4 text-xs text-slate-400 italic">No feeds added yet.</p>';
        }

        function addFeedManual() {
            const input = document.getElementById('new-feed-url');
            const catSelect = document.getElementById('new-feed-category');
            const customCatInput = document.getElementById('custom-category-input');
            const url = input.value.trim();
            let category = catSelect.value === 'Custom' ? customCatInput.value.trim() : catSelect.value;
            if (!category) category = "General";
            if (url && !state.feeds.find(f => f.url === url)) {
                state.feeds.push({ url, category });
                saveFeeds();
                input.value = '';
                customCatInput.value = '';
                customCatInput.classList.add('hidden');
                catSelect.value = "General";
                renderSettingsFeedList();
                renderCategoriesFilter();
                fetchFeeds();
            }
        }

        function removeFeed(index) {
            state.feeds.splice(index, 1);
            saveFeeds();
            renderSettingsFeedList();
            renderCategoriesFilter();
            fetchFeeds();
        }

        function saveFeeds() { localStorage.setItem('rss_feeds_v2', JSON.stringify(state.feeds)); }

        function resetFeeds() {
            if(confirm("Reset all feeds to default?")) {
                state.feeds = [...DEFAULT_FEEDS];
                saveFeeds();
                renderSettingsFeedList();
                renderCategoriesFilter();
                fetchFeeds();
            }
        }

        function handleOPMLUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const statusEl = document.getElementById('import-status');
            statusEl.innerHTML = `<p class="text-xs text-indigo-600">Processing...</p>`;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(text, "text/xml");
                    function parseOutlines(node, category = "General") {
                        let results = [];
                        const children = node.children;
                        for (let child of children) {
                            if (child.tagName === 'outline') {
                                const title = child.getAttribute('title') || child.getAttribute('text');
                                const xmlUrl = child.getAttribute('xmlUrl') || child.getAttribute('url');
                                if (xmlUrl) results.push({ url: xmlUrl, category: category });
                                else if (title) results = results.concat(parseOutlines(child, title));
                            }
                        }
                        return results;
                    }
                    const body = xmlDoc.getElementsByTagName("body")[0];
                    let addedFeeds = parseOutlines(body);
                    if (addedFeeds.length > 0) {
                        addedFeeds.forEach(newFeed => { if (!state.feeds.find(f => f.url === newFeed.url)) state.feeds.push(newFeed); });
                        saveFeeds();
                        renderSettingsFeedList();
                        renderCategoriesFilter();
                        fetchFeeds();
                        statusEl.innerHTML = `<p class="text-xs text-emerald-600 font-bold">Imported ${addedFeeds.length} feeds!</p>`;
                    }
                } catch (err) { statusEl.innerHTML = `<p class="text-xs text-rose-500">Failed.</p>`; }
            };
            reader.readAsText(file);
        }

        // --- RSS Fetching & Content Logic ---

        async function fetchFeeds() {
            if (state.feeds.length === 0) { state.articles = []; renderArticles(); return; }
            state.isRefreshing = true;
            const refreshIcon = document.getElementById('refresh-icon');
            if (refreshIcon) refreshIcon.classList.add('animate-spin');
            try {
                let allItems = [];
                const results = await Promise.all(state.feeds.map(feed => 
                    fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}`)
                        .then(r => r.json())
                        .then(data => ({ ...data, feedCategory: feed.category }))
                        .catch(() => ({ status: 'error' }))
                ));
                results.forEach(res => {
                    if (res.status === 'ok') {
                        allItems.push(...res.items.map(item => ({
                            ...item,
                            id: item.guid || item.link,
                            feedTitle: res.feed.title || new URL(item.link).hostname,
                            category: res.feedCategory
                        })));
                    }
                });
                allItems.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                state.articles = allItems;
                localStorage.setItem('rss_cache_v2', JSON.stringify(allItems));
            } catch (e) { console.error(e); } 
            finally {
                state.isRefreshing = false;
                if (refreshIcon) refreshIcon.classList.remove('animate-spin');
                renderArticles();
            }
        }

        // --- Gemini Functions ---

        async function callGemini(prompt, systemInstruction = "") {
            let retries = 0;
            const maxRetries = 5;
            const run = async () => {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
            };
            while (retries < maxRetries) {
                try { return await run(); } catch (e) {
                    retries++;
                    await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
                }
            }
        }

        async function generateSummary() {
            const article = state.articles.find(a => a.id === state.selectedArticleId);
            const summaryBox = document.getElementById('ai-summary');
            const summaryText = document.getElementById('summary-text');
            summaryBox.classList.remove('hidden');
            summaryText.innerHTML = `<div class="flex items-center gap-2 text-xs"><div class="w-3 h-3 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin"></div> Summarizing...</div>`;
            summaryBox.scrollIntoView({ behavior: 'smooth' });
            const prompt = `3-bullet summary for: ${article.content || article.description}`;
            const summary = await callGemini(prompt, "Professional news analyst briefing.");
            summaryText.innerHTML = summary.replace(/\n/g, '<br>').replace(/- /g, '• ');
        }

        async function analyzeSentiment(article) {
            const sentimentEl = document.getElementById('ai-sentiment');
            const result = await callGemini(`Sentiment (POSITIVE, NEUTRAL, CRITICAL) for: ${article.title}`, "Media sentiment classifier.");
            const label = result.trim().toUpperCase();
            sentimentEl.classList.remove('hidden');
            let theme = label.includes("POSITIVE") ? "bg-emerald-50 text-emerald-700 border-emerald-200" : 
                        label.includes("CRITICAL") ? "bg-rose-50 text-rose-700 border-rose-200" : 
                        "bg-slate-50 text-slate-700 border-slate-200";
            sentimentEl.className = `inline-flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold border ${theme}`;
            sentimentEl.innerText = `✨ AI SENTIMENT: ${label}`;
        }

        async function handleChat() {
            const input = document.getElementById('ai-chat-input');
            const query = input.value.trim();
            if (!query) return;
            state.chatHistory.push({ role: 'user', text: query });
            input.value = "";
            renderChat();
            const article = state.articles.find(a => a.id === state.selectedArticleId);
            const prompt = `Context: ${article.content || article.description}\n\nQ: ${query}`;
            const response = await callGemini(prompt, "Answer using provided content.");
            state.chatHistory.push({ role: 'bot', text: response });
            renderChat();
        }

        function renderChat() {
            const historyEl = document.getElementById('ai-chat-history');
            historyEl.innerHTML = state.chatHistory.map(msg => `
                <div class="ai-chat-bubble ${msg.role === 'user' ? 'ai-user' : 'ai-bot'}">${msg.text}</div>
            `).join('');
            historyEl.scrollTop = historyEl.scrollHeight;
        }

        // --- UI Rendering ---

        function renderArticles() {
            const list = document.getElementById('article-list');
            const shimmer = document.getElementById('shimmer-loader');
            if (shimmer) shimmer.remove();

            let filtered = state.articles;
            if (state.selectedCategory !== 'All') filtered = filtered.filter(a => a.category === state.selectedCategory);
            if (!state.showRead) filtered = filtered.filter(a => !state.readArticles.has(a.id) || state.selectedArticleId === a.id);

            if (filtered.length === 0) {
                list.innerHTML = `<div class="p-12 text-center text-slate-400 text-sm italic">Stream cleared.</div>`;
                return;
            }
            
            list.innerHTML = filtered.map(item => {
                const style = getCategoryStyle(item.category);
                return `
                <div class="article-card p-5 border-b border-slate-50 cursor-pointer ${state.selectedArticleId === item.id ? 'active' : ''} ${state.readArticles.has(item.id) ? 'is-read' : ''}" 
                     onclick="selectArticle('${item.id}')">
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex gap-1.5 overflow-hidden">
                            <span class="text-[9px] font-bold text-white ${style.bg} px-1.5 py-0.5 rounded uppercase tracking-wider shrink-0">${item.category}</span>
                            <span class="text-[9px] font-bold ${style.text} ${style.light} px-1.5 py-0.5 rounded uppercase tracking-wider truncate">${item.feedTitle}</span>
                        </div>
                        <span class="text-[9px] text-slate-400 shrink-0 ml-2">${new Date(item.pubDate).toLocaleDateString()}</span>
                    </div>
                    <h4 class="font-bold text-sm text-slate-800 leading-snug line-clamp-2">${item.title}</h4>
                </div>
            `;}).join('');
        }

        function selectArticle(id) {
            state.selectedArticleId = id;
            markAsRead(id);
            state.chatHistory = [];
            renderChat();
            const article = state.articles.find(a => a.id === id);
            if (!article) return;
            
            renderArticles();
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('reader-view').classList.remove('hidden');
            document.getElementById('content-pane').classList.add('active');
            
            const style = getCategoryStyle(article.category);
            const sourceEl = document.getElementById('reader-source');
            sourceEl.innerText = `${article.category} / ${article.feedTitle}`;
            sourceEl.className = `text-[10px] font-black uppercase tracking-widest ${style.text} ${style.light} px-2 py-0.5 rounded`;
            
            document.getElementById('reader-title').innerText = article.title;
            document.getElementById('reader-date').innerText = new Date(article.pubDate).toLocaleString();
            document.getElementById('reader-original-link').href = article.link;
            document.getElementById('reader-body').innerHTML = article.content || article.description;
            document.getElementById('ai-summary').classList.add('hidden');
            document.getElementById('reader-scroll-container').scrollTop = 0;
            analyzeSentiment(article);
        }

        function closeReader() {
            document.getElementById('content-pane').classList.remove('active');
            state.selectedArticleId = null;
            renderArticles();
        }

        // Pull to Refresh
        let startY = 0;
        window.addEventListener('touchstart', (e) => {
            if (document.getElementById('article-list').scrollTop === 0) startY = e.touches[0].pageY;
            else startY = -1;
        });
        window.addEventListener('touchmove', (e) => {
            if (startY === -1) return;
            const diff = e.touches[0].pageY - startY;
            if (diff > 0) document.getElementById('pull-indicator').style.transform = `translateX(-50%) translateY(${Math.min(diff, 100)}px)`;
        });
        window.addEventListener('touchend', (e) => {
            if (startY !== -1 && (e.changedTouches[0].pageY - startY) > 80) fetchFeeds();
            document.getElementById('pull-indicator').style.transform = `translateX(-50%) translateY(-50px)`;
        });

        document.getElementById('ai-summarize-btn').onclick = generateSummary;
        document.getElementById('ai-chat-send').onclick = handleChat;
        document.getElementById('ai-chat-input').onkeypress = (e) => { if (e.key === 'Enter') handleChat(); };

        window.onload = () => {
            const cache = localStorage.getItem('rss_cache_v2');
            if (cache) { state.articles = JSON.parse(cache); renderArticles(); }
            renderCategoriesFilter();
            fetchFeeds();
        };
    </script>
</body>
</html>
