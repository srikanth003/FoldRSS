<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FoldRSS ✨ Cloud Sync</title>
    
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;800&display=swap');
        
        :root {
            --primary: #4f46e5;
            --bg: #ffffff;
            --surface: #f8fafc;
            --list-width: 400px;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            overscroll-behavior-y: contain;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        .pane { height: 100%; overflow-y: auto; padding-bottom: env(safe-area-inset-bottom); }

        #resizer {
            width: 2px;
            cursor: col-resize;
            background: #f1f5f9;
            transition: background 0.2s;
            position: relative;
            z-index: 40;
            flex-shrink: 0;
        }

        #resizer:hover, #resizer.resizing { background: #4f46e5; }

        @media (min-width: 768px) {
            .pane-list { width: var(--list-width); min-width: 320px; max-width: 50vw; flex-shrink: 0; }
            .pane-content { flex: 1; min-width: 400px; }
        }

        @media (max-width: 767px) {
            #resizer { display: none; }
            .pane-list { width: 100%; }
            .pane-content { 
                position: fixed; right: -100%; width: 100%; z-index: 50; 
                background: white; height: 100vh; transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            }
            .pane-content.active { right: 0; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        .article-card {
            transition: all 0.2s ease;
            border-left-width: 4px;
        }

        .article-card.is-read {
            opacity: 0.5;
            border-left-color: #e2e8f0 !important;
        }

        .insight-tag {
            font-size: 8px;
            font-weight: 800;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }

        #original-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
    </style>
</head>
<body class="text-slate-900 bg-white">

    <div class="app-container" id="app">
        <!-- SIDEBAR LIST -->
        <div class="pane pane-list flex flex-col bg-white border-r border-slate-100">
            <header class="p-6 pb-4 sticky top-0 bg-white/80 backdrop-blur-md z-10">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-xl font-extrabold tracking-tight text-slate-900 flex items-center gap-2">
                            FoldRSS
                            <span id="sync-status" class="sync-indicator bg-slate-200" title="Disconnected"></span>
                        </h1>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Cloud Synced Library</p>
                    </div>
                    <div class="flex items-center gap-1">
                        <button id="toggle-unread" onclick="toggleUnreadOnly()" title="Toggle Unread Only" class="p-2 hover:bg-slate-50 rounded-lg text-slate-400 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                        <button id="open-settings-btn" title="Settings" class="p-2 hover:bg-slate-50 rounded-lg text-slate-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        </button>
                        <button onclick="fetchFeeds()" title="Refresh" class="p-2 hover:bg-slate-50 rounded-lg text-slate-400" id="refresh-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <div id="category-chips" class="flex gap-2 overflow-x-auto no-scrollbar flex-1"></div>
                </div>
            </header>

            <div id="article-list" class="flex-1 overflow-y-auto custom-scrollbar"></div>
        </div>

        <div id="resizer"></div>

        <!-- CONTENT READER -->
        <div id="content-pane" class="pane pane-content flex flex-col bg-white">
            <header id="reader-header" class="h-16 px-6 border-b border-slate-50 flex items-center justify-between sticky top-0 bg-white/95 backdrop-blur-md z-30">
                <div class="flex items-center gap-4">
                    <button onclick="closeContent()" class="md:hidden p-2 -ml-2 hover:bg-black/5 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div class="flex items-center gap-1 bg-slate-100 p-1 rounded-lg">
                        <button id="view-reader-btn" onclick="toggleViewMode('reader')" class="px-3 py-1.5 rounded-md text-[9px] font-black uppercase tracking-widest transition-all">Reader</button>
                        <button id="view-original-btn" onclick="toggleViewMode('original')" class="px-3 py-1.5 rounded-md text-[9px] font-black uppercase tracking-widest transition-all">Original</button>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="summarize-btn" onclick="generateSummary()" class="hidden flex items-center gap-2 px-4 py-2 rounded-lg text-[9px] font-black tracking-widest transition-all hover:opacity-90 active:scale-95 shadow-sm">
                        <span>AI SUMMARY</span>
                    </button>
                    <a id="external-link" href="#" target="_blank" title="Open in new tab" class="p-2 text-slate-300 hover:text-indigo-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </a>
                </div>
            </header>

            <div class="flex-1 relative flex flex-col overflow-hidden">
                <div id="view-reader-container" class="flex-1 overflow-y-auto custom-scrollbar p-6 md:p-20">
                    <article id="article-container" class="max-w-2xl mx-auto">
                        <div id="placeholder" class="py-40 text-center flex flex-col items-center justify-center opacity-10">
                            <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
                            <p class="uppercase tracking-[0.2em] text-[10px] font-black">Open a story</p>
                        </div>
                    </article>
                </div>
                
                <div id="view-original-container" class="absolute inset-0 bg-slate-50 hidden flex flex-col">
                    <div id="iframe-loading" class="absolute inset-0 flex items-center justify-center bg-white z-10">
                        <div class="animate-spin rounded-full h-8 w-8 border-2 border-indigo-500 border-t-transparent"></div>
                    </div>
                    <iframe id="original-iframe" sandbox="allow-scripts allow-same-origin" src="about:blank"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" id="settings-overlay"></div>
        <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 w-full md:max-w-xl bg-white rounded-t-[2rem] md:rounded-2xl shadow-2xl p-8 max-h-[90vh] overflow-y-auto border border-slate-100">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-black text-slate-900">Cloud Library</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Sync ID: <span id="user-id-display" class="select-all">...</span></p>
                </div>
                <button id="close-settings-btn" class="p-2 hover:bg-slate-50 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="space-y-4 mb-8">
                <input type="text" id="new-feed-name" placeholder="Label (e.g. Tech News)" class="w-full border-b border-slate-100 py-3 text-sm font-semibold outline-none focus:border-indigo-500 transition-colors">
                <input type="text" id="new-feed-url" placeholder="RSS Source URL" class="w-full border-b border-slate-100 py-3 text-sm font-semibold outline-none focus:border-indigo-500 transition-colors">
                <div class="flex gap-2">
                    <input type="text" id="new-feed-cat" placeholder="Category" class="flex-1 border-b border-slate-100 py-3 text-sm font-semibold outline-none focus:border-indigo-500">
                    <button id="add-feed-btn" onclick="addFeed()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-black text-[10px] uppercase tracking-widest hover:bg-indigo-700 transition-all">Add Source</button>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Manage Sources</h3>
                    <button onclick="clearAllFeeds()" class="text-[9px] font-bold text-red-400 hover:text-red-600 uppercase">Wipe all</button>
                </div>
                <div id="feeds-list" class="space-y-1"></div>
            </div>

            <div class="flex gap-2 mt-8">
                <button onclick="document.getElementById('opml-file-input').click()" class="flex-1 flex items-center justify-center gap-2 p-4 bg-slate-50 rounded-xl hover:bg-slate-100 transition-all">
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-600">Import OPML</span>
                </button>
                <button onclick="exportOPML()" id="export-opml-btn" class="flex-1 flex items-center justify-center gap-2 p-4 border border-slate-100 rounded-xl hover:bg-slate-50 transition-all">
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Export</span>
                </button>
                <input type="file" id="opml-file-input" class="hidden" accept=".opml,.xml" onchange="importOPML(event)">
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const apiKey = ""; 
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'foldrss-sync-app';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const state = {
            user: null,
            feeds: [],
            articles: [],
            insights: {},
            readArticles: new Set(),
            activeCategory: 'All',
            unreadOnly: false,
            selectedId: null,
            isResizing: false,
            processingInsights: new Set(),
            viewMode: 'reader'
        };

        // --- AUTHENTICATION & SYNC ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth failed:", err);
            }
        };

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                document.getElementById('user-id-display').innerText = user.uid;
                document.getElementById('sync-status').className = "sync-indicator bg-emerald-400";
                document.getElementById('sync-status').title = "Synced";
                setupRealtimeSync(user.uid);
            } else {
                document.getElementById('sync-status').className = "sync-indicator bg-red-400";
            }
        });

        const setupRealtimeSync = (uid) => {
            // Path: /artifacts/{appId}/public/data/users/{uid}
            // Using public data path for easy sync across devices
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_data', uid);

            onSnapshot(userDocRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    state.feeds = data.feeds || [];
                    state.readArticles = new Set(data.readArticles || []);
                    state.insights = data.insights || {};
                    
                    renderSettings();
                    renderCategoriesFilter();
                    // If we have feeds but no articles, or feeds changed, refresh
                    fetchFeeds();
                } else {
                    // Initialize empty profile if none exists
                    setDoc(userDocRef, { feeds: [], readArticles: [], insights: {} });
                }
            }, (err) => console.error("Sync error:", err));
        };

        // --- CLOUD ACTIONS ---
        const cloudUpdate = async (updates) => {
            if (!state.user) return;
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_data', state.user.uid);
            try {
                await updateDoc(userDocRef, updates);
            } catch (e) {
                // If update fails because doc doesn't exist, set it
                await setDoc(userDocRef, updates, { merge: true });
            }
        };

        // --- APP LOGIC ---
        const getCategoryTheme = (cat) => {
            if (cat === 'All') return { hex: '#4f46e5', lightHex: '#f5f3ff', textHex: '#4338ca', borderHex: '#e0e7ff' };
            let hash = 0;
            for (let i = 0; i < cat.length; i++) hash = cat.charCodeAt(i) + ((hash << 5) - hash);
            const h = Math.abs(hash % 360);
            return {
                hex: `hsl(${h}, 65%, 50%)`,
                lightHex: `hsl(${h}, 65%, 96%)`,
                borderHex: `hsl(${h}, 65%, 85%)`,
                textHex: `hsl(${h}, 65%, 30%)`
            };
        };

        async function callGemini(prompt, systemPrompt = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            for (let i = 0; i < 5; i++) {
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (res.status === 429) { await new Promise(r => setTimeout(r, Math.pow(2, i) * 2000)); continue; }
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) { await new Promise(r => setTimeout(r, 1000)); }
            }
        }

        async function processInsight(articleId) {
            if (state.insights[articleId] || state.processingInsights.has(articleId)) return;
            const article = state.articles.find(a => a.id === articleId);
            if (!article) return;
            state.processingInsights.add(articleId);
            try {
                const label = await callGemini(`Title: ${article.title}`, "Return a 2-word professional badge (ALL CAPS). No icons.");
                const insightVal = label.trim().toUpperCase().substring(0, 15);
                state.insights[articleId] = insightVal;
                
                // Sync insight to cloud
                const update = {};
                update[`insights.${articleId.replace(/\./g, '_')}`] = insightVal; // sanitize key for Firestore
                cloudUpdate(update);
                
                updateInsightUI(articleId);
            } catch (e) {} finally { state.processingInsights.delete(articleId); }
        }

        function updateInsightUI(id) {
            const sanitizedId = id.replace(/\./g, '_');
            const el = document.querySelector(`[data-insight-id="${CSS.escape(id)}"]`);
            if (el) { 
                el.innerText = state.insights[id] || state.insights[sanitizedId]; 
                el.classList.remove('loading-shimmer'); 
                el.classList.add('bg-slate-100', 'text-slate-500');
            }
        }

        async function generateSummary() {
            const article = state.articles.find(a => a.id === state.selectedId);
            const container = document.getElementById('ai-summary-box');
            if (!article || !container) return;
            if (state.viewMode !== 'reader') toggleViewMode('reader');
            const theme = getCategoryTheme(article.category);
            container.innerHTML = `<div class="p-6 bg-slate-50 rounded-xl animate-pulse"><div class="h-2 w-1/4 bg-slate-200 mb-4"></div><div class="h-2 w-full bg-slate-100"></div></div>`;
            try {
                const summary = await callGemini(`Article: ${article.title}\nContent: ${article.content || article.description}`, "3 short bullet points. No icons.");
                const items = summary.split('\n').filter(s => s.trim()).map(s => `<p class="mb-2 text-sm font-medium">• ${s.replace(/^[•\-\*]\s*/, '')}</p>`).join('');
                container.innerHTML = `<div class="p-6 rounded-xl mb-10" style="background-color: ${theme.lightHex}; border: 1px solid ${theme.borderHex}"><div class="flex items-center gap-2 mb-4"><span class="text-[9px] font-black uppercase tracking-widest" style="color: ${theme.textHex}">Intelligence Brief</span></div><div style="color: ${theme.textHex}">${items}</div></div>`;
            } catch (e) { container.innerHTML = ""; }
        }

        window.toggleViewMode = (mode) => {
            state.viewMode = mode;
            const readerContainer = document.getElementById('view-reader-container');
            const originalContainer = document.getElementById('view-original-container');
            const readerBtn = document.getElementById('view-reader-btn');
            const originalBtn = document.getElementById('view-original-btn');
            const iframe = document.getElementById('original-iframe');
            const article = state.articles.find(a => a.id === state.selectedId);

            if (mode === 'reader') {
                readerContainer.classList.remove('hidden');
                originalContainer.classList.add('hidden');
                readerBtn.className = "px-3 py-1.5 rounded-md text-[9px] font-black uppercase tracking-widest bg-white shadow-sm text-indigo-600";
                originalBtn.className = "px-3 py-1.5 rounded-md text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600";
            } else {
                readerContainer.classList.add('hidden');
                originalContainer.classList.remove('hidden');
                originalBtn.className = "px-3 py-1.5 rounded-md text-[9px] font-black uppercase tracking-widest bg-white shadow-sm text-indigo-600";
                readerBtn.className = "px-3 py-1.5 rounded-md text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600";
                if (article && iframe.src !== article.link) {
                    document.getElementById('iframe-loading').classList.remove('hidden');
                    iframe.src = article.link;
                    iframe.onload = () => document.getElementById('iframe-loading').classList.add('hidden');
                }
            }
        }

        window.toggleSettings = () => {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) renderSettings();
        }

        function renderSettings() {
            const list = document.getElementById('feeds-list');
            if (state.feeds.length === 0) {
                list.innerHTML = `<p class="py-8 text-center text-[10px] font-black uppercase tracking-widest text-slate-300">No sources connected</p>`;
                return;
            }
            list.innerHTML = state.feeds.map((f, i) => {
                const theme = getCategoryTheme(f.category);
                return `
                <div class="flex items-center justify-between p-3 border-b border-slate-50 group">
                    <div class="min-w-0 pr-4">
                        <p class="text-xs font-bold truncate">${f.name || 'Untitled Source'}</p>
                        <p class="text-[9px] font-black uppercase tracking-widest mt-0.5" style="color: ${theme.textHex}">${f.category}</p>
                    </div>
                    <button onclick="removeFeed(${i})" class="text-slate-300 hover:text-red-400 p-2 md:opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"></path></svg>
                    </button>
                </div>`;
            }).join('');
        }

        window.removeFeed = (index) => {
            const newFeeds = [...state.feeds];
            newFeeds.splice(index, 1);
            cloudUpdate({ feeds: newFeeds });
        };

        window.clearAllFeeds = () => {
            if(confirm("Wipe your cloud library?")) {
                cloudUpdate({ feeds: [], readArticles: [], insights: {} });
            }
        };

        window.addFeed = () => {
            const urlInput = document.getElementById('new-feed-url');
            const nameInput = document.getElementById('new-feed-name');
            const catInput = document.getElementById('new-feed-cat');
            if (!urlInput.value.trim()) return;
            
            const newFeeds = [...state.feeds, { 
                url: urlInput.value.trim(), 
                name: nameInput.value.trim() || "Source", 
                category: catInput.value.trim() || 'General' 
            }];
            cloudUpdate({ feeds: newFeeds });
            urlInput.value = ''; nameInput.value = ''; catInput.value = '';
        }

        window.toggleUnreadOnly = () => {
            state.unreadOnly = !state.unreadOnly;
            const btn = document.getElementById('toggle-unread');
            btn.classList.toggle('bg-indigo-600', state.unreadOnly);
            btn.classList.toggle('text-white', state.unreadOnly);
            renderArticles();
        }

        function renderArticles() {
            const list = document.getElementById('article-list');
            let filtered = state.activeCategory === 'All' ? state.articles : state.articles.filter(a => a.category === state.activeCategory);
            if (state.unreadOnly) filtered = filtered.filter(a => !state.readArticles.has(a.id));

            if (filtered.length === 0) {
                list.innerHTML = `<div class="p-20 text-center opacity-30 text-[10px] font-black uppercase tracking-widest">Inbox Zero</div>`;
                return;
            }

            list.innerHTML = filtered.map(a => {
                const theme = getCategoryTheme(a.category);
                const isActive = state.selectedId === a.id;
                const isRead = state.readArticles.has(a.id);
                // Handle sanitized keys from firestore
                const insight = state.insights[a.id] || state.insights[a.id.replace(/\./g, '_')];
                return `
                <div onclick="selectArticle('${a.id}')" class="article-card p-6 cursor-pointer border-b border-slate-50 transition-all ${isActive ? 'bg-slate-50' : 'bg-white hover:bg-slate-50/50'} ${isRead && !isActive ? 'is-read' : ''}" style="border-left-color: ${isRead ? '#e2e8f0' : theme.hex}">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[9px] font-black uppercase tracking-widest truncate max-w-[150px]" style="color: ${isRead ? '#94a3b8' : theme.textHex}">${a.feedTitle}</span>
                        <span data-insight-id="${a.id}" class="insight-tag ${!insight ? 'loading-shimmer text-transparent' : 'bg-slate-100 text-slate-500'}">${insight || 'LOADING'}</span>
                    </div>
                    <h3 class="font-bold leading-snug text-sm">${a.title}</h3>
                    <div class="mt-3 text-[9px] font-bold text-slate-400 uppercase tracking-widest flex justify-between">
                        <span>${new Date(a.pubDate).toLocaleDateString([], { month: 'short', day: 'numeric' })}</span>
                    </div>
                </div>`;
            }).join('');
            initObserver();
        }

        function initObserver() {
            if (window.cardObserver) window.cardObserver.disconnect();
            window.cardObserver = new IntersectionObserver((entries) => {
                entries.forEach(e => { if (e.isIntersecting) {
                    const idMatch = e.target.onclick.toString().match(/'(.*?)'/);
                    if (idMatch) processInsight(idMatch[1]);
                }});
            }, { threshold: 0.1 });
            document.querySelectorAll('.article-card').forEach(el => window.cardObserver.observe(el));
        }

        window.selectArticle = (id) => {
            state.selectedId = id;
            if (!state.readArticles.has(id)) {
                state.readArticles.add(id);
                cloudUpdate({ readArticles: Array.from(state.readArticles) });
            }
            
            const article = state.articles.find(a => a.id === id);
            if (!article) return;
            const theme = getCategoryTheme(article.category);
            document.getElementById('content-pane').classList.add('active');
            const btn = document.getElementById('summarize-btn');
            btn.classList.remove('hidden');
            btn.style.backgroundColor = theme.hex;
            btn.style.color = '#ffffff';
            document.getElementById('external-link').href = article.link;
            const container = document.getElementById('article-container');
            container.innerHTML = `
                <div id="ai-summary-box"></div>
                <div class="flex items-center gap-2 mb-6">
                    <span class="text-[10px] font-black uppercase tracking-widest px-2 py-1 rounded" style="background: ${theme.lightHex}; color: ${theme.textHex}">${article.feedTitle}</span>
                </div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 mb-10 leading-tight">${article.title}</h1>
                <div class="prose prose-slate max-w-none text-slate-600 leading-relaxed font-medium">
                    ${article.content || article.description}
                </div>
            `;
            toggleViewMode(state.viewMode);
            renderArticles();
            document.getElementById('view-reader-container').scrollTop = 0;
        };

        window.fetchFeeds = async () => {
            if (state.feeds.length === 0) {
                state.articles = [];
                renderArticles();
                return;
            }
            const btn = document.getElementById('refresh-btn');
            if (btn) btn.classList.add('animate-spin');
            const all = [];
            for (const f of state.feeds) {
                try {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(f.url)}`);
                    const data = await res.json();
                    if (data.status === 'ok') {
                        data.items.forEach(i => all.push({ 
                            ...i, id: i.guid || i.link, 
                            feedTitle: f.name || data.feed.title || "Unknown Feed", 
                            category: f.category 
                        }));
                    }
                } catch(e) {}
            }
            state.articles = all.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));
            renderArticles();
            if (btn) btn.classList.remove('animate-spin');
        }

        window.setActiveCategory = (cat) => { state.activeCategory = cat; renderCategoriesFilter(); renderArticles(); };

        function renderCategoriesFilter() {
            const uniqueCats = Array.from(new Set(state.feeds.map(f => f.category))).filter(Boolean);
            const cats = ['All', ...uniqueCats];
            document.getElementById('category-chips').innerHTML = cats.map(c => {
                const theme = getCategoryTheme(c);
                const isActive = state.activeCategory === c;
                return `<button onclick="setActiveCategory('${c}')" class="whitespace-nowrap px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${isActive ? '' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}" style="${isActive ? `background-color: ${theme.hex}; color: white` : ''}">${c}</button>`
            }).join('');
        }

        window.exportOPML = () => {
            let opml = `<?xml version="1.0" encoding="UTF-8"?><opml version="1.0"><head><title>FoldRSS Export</title></head><body>`;
            state.feeds.forEach(f => opml += `<outline type="rss" text="${f.name}" title="${f.name}" xmlUrl="${f.url}" category="${f.category}" />`);
            opml += `</body></opml>`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([opml], { type: 'text/xml' }));
            a.download = `foldrss_export.opml`; a.click();
        }

        window.importOPML = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const xml = new DOMParser().parseFromString(ev.target.result, "text/xml");
                const outlines = Array.from(xml.querySelectorAll('outline'));
                const newFeeds = [...state.feeds];
                const currentUrls = new Set(newFeeds.map(f => f.url));

                outlines.forEach(o => {
                    const url = o.getAttribute('xmlUrl');
                    if (url && !currentUrls.has(url)) {
                        const name = o.getAttribute('text') || o.getAttribute('title') || "Source";
                        let category = o.getAttribute('category');
                        if (!category && o.parentElement.tagName.toLowerCase() === 'outline') {
                            category = o.parentElement.getAttribute('text') || o.parentElement.getAttribute('title');
                        }
                        newFeeds.push({ url, name, category: category || 'General' });
                        currentUrls.add(url);
                    }
                });
                cloudUpdate({ feeds: newFeeds });
            };
            reader.readAsText(file);
        }

        window.closeContent = () => { 
            document.getElementById('content-pane').classList.remove('active'); 
            document.getElementById('original-iframe').src = 'about:blank';
            state.selectedId = null; 
            renderArticles(); 
        }

        // --- DOM INIT ---
        document.getElementById('open-settings-btn').onclick = window.toggleSettings;
        document.getElementById('close-settings-btn').onclick = window.toggleSettings;
        document.getElementById('settings-overlay').onclick = window.toggleSettings;

        const resizer = document.getElementById('resizer');
        resizer.onmousedown = () => state.isResizing = true;
        window.onmousemove = (e) => { 
            if (!state.isResizing) return; 
            const width = Math.max(300, Math.min(e.clientX, window.innerWidth * 0.5)); 
            document.documentElement.style.setProperty('--list-width', `${width}px`); 
        };
        window.onmouseup = () => state.isResizing = false;

        // Start Auth
        initAuth();
    </script>
</body>
</html>
